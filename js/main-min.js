function buildTipoIluminacao(){for(var e=0;e<tipoInstalacao.length;e++)$("#tipo-iluminacao").append($('<option class="op"> </option>').val(e).html(tipoInstalacao[e].nome))}function buildDadosTable(){if(espacoCount=0,espacoCount++,tipoInstalacao[$("#tipo-iluminacao").val()].nome==EXTERIOR){estado=EXTERIOR;var e='<table class="table table-bordered" id="dataTable"><tbody><tr style="font-weight:bold;" class="titulo_row"><th class="tituloTH">Espaço</th><th class="tituloTH">Designação</th><th class="tituloTH">&nbsp</th></tr>';e+='<tr class="textTR" name="espaco" id="clone1" hidden>',e+='<td class="in"></td>',e+='<td class="in"><input class="form-control xInput" type="text" placeholder="Designação" id="designacao" name="designacao"></input></td>',e+='<td class="in"><button class="but-dados" type="button" id="remove-espaco" name="remove-espaco" onclick="removeEspaco(this)">Remover</button></td>',e+="</tr>",e+='<tr class="textTR" name="espaco">',e+='<td class="in">'+espacoCount+"</td>",e+='<td class="in"><input class="form-control xInput" type="text" placeholder="Designação" id="designacao'+espacoCount+'" name="designacao"></input></td>',e+='<td class="in"><button class="but-dados" type="button" id="remove-espaco" name="remove-espaco" onclick="removeEspaco(this)">Remover</button></td>',e+="</tr>",e+='<tr class="textTR" name="espaco" id="adiciona-row"><td class="in"></td><td class="in"></td><td class="in"><button class="but-dados" type="button" id="adiciona-espaco" name="adiciona-espaco" onclick="adicionaEspaco()">Adicionar</button></td></tr>'}else if(tipoInstalacao[$("#tipo-iluminacao").val()].nome==INTERIOR){estado=INTERIOR;var e='<table class="table table-bordered" id="dataTable"><tbody><tr style="font-weight:bold;" class="titulo_row"><th class="tituloTH">Espaço</th><th class="tituloTH">Tipologia do espaço</th><th class="tituloTH">Designação</th><th class="tituloTH">Área (m2)</th><th class="tituloTH">&nbsp</th></tr>';e+='<tr class="textTR" name="espaco" id="clone1" hidden>',e+='<td class="in"></td>',e+='<td class="select-cell"><select name="tipologia" class="interior" id="tipologia">',e+='<option class="op">Seleccionar opção</option>';for(var o=0;o<tipoTipologia.length;o++)e+='<option class="op" value="'+o+'">'+tipoTipologia[o].nome+"</option>";e+="</select></td>",e+='<td class="in"><input class="form-control xInput" type="text" placeholder="Designação" id="designacao" name="designacao"></input></td>',e+='<td class="in"><input class="form-control xInput" type="number" placeholder="Área" class="interior" id="area" name="area"></input></td>',e+='<td class="in"><button class="but-dados" type="button" id="remove-espaco" name="remove-espaco" onclick="removeEspaco(this)">Remover</button></td>',e+="</tr>",e+='<tr class="textTR" name="espaco">',e+='<td class="in">'+espacoCount+"</td>",e+='<td class="select-cell"><select name="tipologia" class="interior" id="tipologia'+espacoCount+'">',e+='<option class="op">Seleccionar opção</option>';for(var o=0;o<tipoTipologia.length;o++)e+='<option class="op" value="'+o+'">'+tipoTipologia[o].nome+"</option>";e+="</select></td>",e+='<td class="in"><input class="form-control xInput" type="text" placeholder="Designação" id="designacao'+espacoCount+'" name="designacao"></input></td>',e+='<td class="in"><input class="form-control xInput" type="number" placeholder="Área" class="interior" id="area'+espacoCount+'" name="area"></input></td>',e+='<td class="in"><button class="but-dados" type="button" id="remove-espaco" name="remove-espaco" onclick="removeEspaco(this)">Remover</button></td>',e+="</tr>",e+='<tr class="textTR" name="espaco" id="adiciona-row"><td class="in"></td><td class="in"></td><td class="in"></td><td class="in"></td><td class="in"><button class="but-dados" type="button" id="adiciona-espaco" name="adiciona-espaco" onclick="adicionaEspaco()">Adicionar</button></td></tr>',e+="<tr>",e+='<td colspan="3">TOTAL</td>',e+='<td id="total-area">0m2</td>',e+="<td>&nbsp</td>",e+="</tr>"}$("#espacos-iluminacao").html(e+"</tbody></table>");var t=document.getElementsByName("area");$(t).change(function(e){var o=totalArea(t);$("#total-area").html(o+" m2")})}function buildEspaco(){for(var e=0;e<tipoTipologia.length;e++)$("#tipologia").append($('<option class="op"> </option>').val(e).html(tipoTipologia[e].nome));adicionaEspaco()}function buildFonteLuz(){var e=document.getElementsByName("espaco-fonte-luz");for(t=e.length-1;t>0;t--)$(e[t]).remove();var o=document.getElementsByName("tipo-fonte-luz-op");for(t=o.length-1;t>=0;t--)$(o[t]).remove();for(var t=0;t<tipoFonteLuz.length;t++)for(var a=0;a<tipoFonteLuz[t].aplicacaoPotencia.length;a++)if(tipoFonteLuz[t].aplicacaoPotencia[a].match(estado)){$("#tipo-fonte-luz").append($('<option name="tipo-fonte-luz-op" class="op"></option>').val(t).html(tipoFonteLuz[t].tipo));break}for(var i=$("#espaco-fonte-luz"),n,t=1;t<=espacoCount;t++){espaco[t].id=t,n=i.clone(),n.find("td").eq(0).html(t),n.find("td").eq(1).html(espaco[t].designacao),n.find("td").eq(2).find("input").attr("id","quantidade-fonte-luz"+t),n.find("td").eq(3).find("select").attr("id","tipo-fonte-luz"+t),n.find("td").eq(4).find("select").attr("id","potencia-fonte-luz"+t),n.find("td").eq(5).find("input").attr("id","potencia-fonte-luz-input"+t),n.find("td").eq(6).find("input").attr("id","horas-funcionamento-fonte-luz"+t),n.insertBefore("#total-fonte-luz-row"),n.show();var s=document.getElementsByName("quantidade-fonte-luz"),d=document.getElementsByName("potencia-fonte-luz"),c=n.find("td").eq(2).find("input"),l=n.find("td").eq(4).find("select");$(c).change(function(e){var o=totalQtFonteLuz(s);$("#total-fonte-luz-row").find("td").eq(1).html(o),o=totalPotenciaFonteLuz(d),$("#total-fonte-luz-row").find("td").eq(2).html(o+"W")}),$(l).change(function(e){var o=totalPotenciaFonteLuz(d);$("#total-fonte-luz-row").find("td").eq(2).html(o+"W")});var r=document.getElementsByName("tipo-fonte-luz"),u=n.find("td").eq(3).find("select");$(u).change(function(e){var o=$(e.target).parent("td").parent("tr").find("td").eq(5),t=$(e.target).parent("td").parent("tr").find("td").eq(7).find("input"),a=$(e.target).parent("td").parent("tr").find("td").eq(4);$(e.target).val()==OUTROS?($(o).change(function(){var e=totalPotenciaFonteLuz(d);$("#total-fonte-luz-row").find("td").eq(2).html(e+"W")}),a.hide(),o.show(),t.val(""),t.removeAttr("disabled")):(t.val(tipoFonteLuz[$(e.target).val()].rendimento),a.show(),o.hide())})}checkFonteLuz()}function buildMedidas(){$("#reguladores-fluxo-medidas").find("option:gt(0)").remove(),$("#sensores-medidas").find("option:gt(0)").remove(),$("#sistemas-gestao-medidas").find("option:gt(0)").remove(),$("#fonte-luz-medidas").find("option:gt(0)").remove();var e=document.getElementsByName("espaco-medidas");for(a=e.length-1;a>0;a--)$(e[a]).remove();for(var o=$("#espaco-medidas"),t,a=1;a<=espacoCount;a++){t=o.clone(),t.find("td").eq(0).html(a),t.find("td").eq(1).html(espaco[a].designacao),t.find("td").eq(2).find("select").attr("id","fonte-luz-medidas"+a);var i=[];for(i=tipoFonteLuz[fonteLuz[a].tipo].medidas.split(","),k=0;k<medidas.length;k++){var n=!1;for(h=0;h<i.length;h++)if(""!=i[h]&&void 0!=i[h]&&i[h]==k){n=!0;break}if(n&&fonteLuz[a].potenciaUnitFinal!=medidas[k].nome)if(medidas[k].nome.search("(AP)")>0||medidas[k].nome.search("(BP)")>0){var s=medidas[k].nome.search("(AP)")>0?medidas[k].nome.search("(AP)"):medidas[k].nome.search("(BP)");t.find("td").eq(2).find("#fonte-luz-medidas"+a).append($('<option class="op"> </option>').val(k).html(medidas[k].nome.substring(0,s-1)+" ("+medidas[k].poupanca+" lm/W)"))}else t.find("td").eq(2).find("#fonte-luz-medidas"+a).append($('<option class="op"> </option>').val(k).html(medidas[k].nome+" ("+medidas[k].poupanca+" lm/W)"))}t.find("td").eq(3).find("select").attr("id","reguladores-fluxo-medidas"+a),t.find("td").eq(4).find("select").attr("id","sensores-medidas"+a),t.find("td").eq(5).find("select").attr("id","sistemas-gestao-medidas"+a);for(var d=0;d<tipoMedidas.length;d++)t.find("td").eq(3).find("#reguladores-fluxo-medidas"+a).append($('<option class="op"> </option>').val(d).html(tipoMedidas[d])),t.find("td").eq(4).find("#sensores-medidas"+a).append($('<option class="op"> </option>').val(d).html(tipoMedidas[d])),t.find("td").eq(5).find("#sistemas-gestao-medidas"+a).append($('<option class="op"> </option>').val(d).html(tipoMedidas[d]));t.find("td").eq(3).find("#reguladores-fluxo-medidas"+a).val(1),t.find("td").eq(4).find("#sensores-medidas"+a).val(1),t.find("td").eq(5).find("#sistemas-gestao-medidas"+a).val(1),t.insertBefore("#total-medidas-row"),t.show()}}function calculaHorasFuncionamento(){var e=document.getElementsByName("quantidade-fonte-luz");$(e).change(function(e){var o=$(e.target),t=o.parent("td").parent("tr").find("td").eq(6).find("input");estado==EXTERIOR&&o.val()>0?t.val(horasAnuaisFunc):t.val(0)})}function geraPotencia(){var e=document.getElementsByName("tipo-fonte-luz"),o="",t="";$(e).change(function(e){if(o=$(e.target).parent("td").parent("tr").find("td").eq(4).find("select"),""!=$(e.target).val()){t=$(e.target).val(),$(o).length>0&&($(o).find("option").remove(),$(o).append($('<option value="">Seleccionar opção</option>')));for(var a=0;a<tipoFonteLuz[t].aplicacaoPotencia.length;a++)tipoFonteLuz[t].aplicacaoPotencia[a].match(estado)&&$(o).append($('<option class="op"> </option>').val(a).html(tipoFonteLuz[t].potencia[a]))}else $(o).find("option").remove(),$(o).append($('<option value="">Seleccionar opção</option>'))})}function checkFonteLuz(){geraPotencia(),calculaHorasFuncionamento()}function checkTipoIluminacao(){$("#tipo-iluminacao").change(function(){""!=$("#tipo-iluminacao").val()?($("#custo-unit-iluminacao-titulo").show(),$("#custo-unit-iluminacao").show(),$("#custo-unit-iluminacao-titulo-label").show(),$("#custo-unit-iluminacao").val(tipoInstalacao[$("#tipo-iluminacao").val()].custo_unit),$("#iluminacao").show(),tipoInstalacao[$("#tipo-iluminacao").val()].nome==INTERIOR?(estado=INTERIOR,estadoNum=INT,showInterior()):tipoInstalacao[$("#tipo-iluminacao").val()].nome==EXTERIOR&&(estado=EXTERIOR,estadoNum=EXT,showExterior()),buildDadosTable()):($("#iluminacao").hide(),$("#custo-unit-iluminacao").hide(),$("#custo-unit-iluminacao-titulo").hide(),$("#custo-unit-iluminacao-titulo-label").hide())})}function showExterior(){$(".interior").hide(),$(".col-medida").removeAttr('colspan="4"').attr('colspan="3"')}function showInterior(){$(".interior").show()}function removeEspaco(e){$(e).closest("tr").remove(),espacoCount--;var o=document.getElementsByName("area"),t=totalArea(o);$("#total-area").html(t+" m2")}function adicionaEspaco(){espacoCount++;var e=$("#clone1"),o=e.clone();o.find("td").eq(0).html(espacoCount),o.find("td").eq(1).find("select").attr("id","tipologia"+espacoCount),o.find("td").eq(2).find("input").attr("id","designacao"+espacoCount),o.find("td").eq(3).find("input").attr("id","area"+espacoCount),o.find("td").eq(4).find("button").attr("id","remove-espaco"+espacoCount),o.insertBefore("#adiciona-row"),o.show();var t=document.getElementsByName("area");$(t).change(function(e){var o=totalArea(t);$("#total-area").html(o+" m2")})}function recolheDados(){for(var e=document.getElementsByName("espaco");espaco.length>1;)espaco.pop();for(var o=1;o<=espacoCount;o++)if(estado==INTERIOR){var t=$(e[o]).find("td").eq(1).find("select").val(),a=$(e[o]).find("td").eq(2).find("input").val(),i=$(e[o]).find("td").eq(3).find("input").val();espaco.push({id:o,tipologia:t,designacao:a,area:i})}else if(estado==EXTERIOR){var a=$(e[o]).find("td").eq(1).find("input").val();espaco.push({id:o,designacao:a})}tipoInstalacao[estadoNum].custo_unit=$("#custo-unit-iluminacao").val(),checkCamposDados()}function checkCamposDados(){var e=!1;if(espaco.length>1)for(var o=1;o<espaco.length;o++){if(estado==INTERIOR){if(""!==espaco[o].area&&espaco[o].area>0&&""!==espaco[o].designacao&&""!==espaco[o].tipologia&&tipoInstalacao[estadoNum].custo_unit>0)continue;alert("Faltam preencher campos"),e=!0;break}if(estado==EXTERIOR){if(""!==espaco[o].designacao&&tipoInstalacao[estadoNum].custo_unit>0)continue;alert("Faltam preencher campos"),e=!0;break}}else alert("É necessário pelo menos 1 espaço para continuar");e||(nextStep(),buildFonteLuz())}function recolheFonteLuz(){for(var e=document.getElementsByName("espaco-fonte-luz");fonteLuz.length>1;)fonteLuz.pop();for(var o=1;o<=espacoCount;o++){var t=$(e[o]).find("td").eq(1).text(),a=$(e[o]).find("td").eq(2).find("input").val(),i=$(e[o]).find("td").eq(7).find("input").val(),n=$(e[o]).find("td").eq(3).find("select").val(),s=0;if(void 0!==n&&""!==n&&n==OUTROS)s=$(e[o]).find("td").eq(5).find("input").val();else{if(!(void 0!=n&&""!==n&&n>=0)){alert("Faltam preencher campos");break}s=tipoFonteLuz[n].potencia[$(e[o]).find("td").eq(4).find("select").val()]}var d=calculaAP_BP(s,tipoFonteLuz[n].rendimento,tipoFonteLuz[LED].rendimento);d>=25?estadoPotenciaUnitFinal=BP:d<25&&(estadoPotenciaUnitFinal=AP);var c=$(e[o]).find("td").eq(6).find("input").val();fonteLuz.push({espacoNum:o,designacao:t,quantidade:a,tipo:n,potencia:s,horasFuncionamento:c,potenciaUnitFinal:estadoPotenciaUnitFinal,rendimento:i,medidasUpgrade:tipoFonteLuz[n].medidas})}checkCamposFonteLuz()}function checkCamposFonteLuz(){for(var e=!1,o=1;o<fonteLuz.length;o++){if(fonteLuz[o].horasFuncionamento<0||fonteLuz[o].horasFuncionamento>8760){alert(1==$("#tipo-iluminacao").val()?"ERRO -  Horas de funconamento devem ser 11h/dia x 365dias/ano = 4015 hora":"ERRO -  Horas de funconamento devem ser 8h/dia x 5dias/semana x 52semanas/ano = 2080 horas"),e=!0;break}if(!(fonteLuz[o].quantidade>=0&&""!==fonteLuz[o].tipo&&""!==fonteLuz[o].potencia&&fonteLuz[o].horasFuncionamento>0&&fonteLuz[o].horasFuncionamento<=8760)){alert("Faltam preencher campos"),e=!0;break}}!e&&fonteLuz.length>1&&(nextStep(),firstTimeMedidas=!1,buildMedidas(),calculaCenarioInicial())}function recolheMedidas(){for(var e=document.getElementsByName("espaco-medidas");medidasDados.length>1;)medidasDados.pop();for(var o=1;o<=espacoCount;o++){var t=$(e[o]).find("td").eq(1).text(),a=$(e[o]).find("td").eq(2).find("select").val(),i=$(e[o]).find("td").eq(3).find("select").val(),n=$(e[o]).find("td").eq(4).find("select").val(),s=$(e[o]).find("td").eq(5).find("select").val();medidasDados.push({espacoNum:o,designacao:t,fonteLuz:a,reguladoresFluxo:i,sensores:n,sistemaGestao:s})}checkCamposMedidas()}function checkCamposMedidas(){for(var e=!1,o=1;o<medidasDados.length;o++){if(estado==EXTERIOR){if(""!==medidasDados[o].reguladoresFluxo&&""!==medidasDados[o].sistemaGestao)continue;alert("Faltam preencher campos"),e=!0;break}if(estado==INTERIOR){if(""!==medidasDados[o].reguladoresFluxo&&""!==medidasDados[o].sensores&&""!==medidasDados[o].sistemaGestao)continue;alert("Faltam preencher campos"),e=!0;break}}e||(nextStep(),calculaCenarioFinal(),calculaInvestimento(),buildResumo())}function buildResumo(){resumoCenarios=[{nome:"Cenário Inicial",potencia:0,consumoAnual:0,custosEnergeticos:0},{nome:"Cenário Final",potencia:0,consumoAnual:0,custosEnergeticos:0}],resumoGeral={reducaoCustos1:"",reducaoCustos2:"",investimento:"",payback:""},resumoCenarios[0].potencia=cenarioInicial[TOTAL].potencia.toFixed(0),resumoCenarios[0].consumoAnual=cenarioInicial[TOTAL].consumo.toFixed(0),resumoCenarios[0].custosEnergeticos=cenarioInicial[TOTAL].custoEnergia.toFixed(0),resumoCenarios[1].potencia=cenarioFinal[TOTAL].potencia.toFixed(0),resumoCenarios[1].consumoAnual=cenarioFinal[TOTAL].consumoFinal.toFixed(0),resumoCenarios[1].custosEnergeticos=cenarioFinal[TOTAL].custoEnergia.toFixed(0),resumoGeral.reducaoCustos1=investimento[TOTAL].reducaoCustos1.toFixed(0),resumoGeral.reducaoCustos2=isNaN(resumoCenarios[0].custosEnergeticos)?" - ":(resumoGeral.reducaoCustos1/resumoCenarios[0].custosEnergeticos*100).toFixed(0),resumoGeral.investimento=investimento[TOTAL].investimento.toFixed(0),resumoGeral.payback=isNaN(investimento[TOTAL].pri)?" - ":investimento[TOTAL].pri.toFixed(1),$("#potencia-1-resumo").html(resumoCenarios[INICIAL].potencia+" W"),$("#consumo-anual-1-resumo").html(resumoCenarios[INICIAL].consumoAnual+" kWh"),$("#custos-energeticos-1-resumo").html(resumoCenarios[INICIAL].custosEnergeticos+" €"),$("#potencia-2-resumo").html(resumoCenarios[FINAL].potencia+" W"),$("#consumo-anual-2-resumo").html(resumoCenarios[FINAL].consumoAnual+" kWh"),$("#custos-energeticos-2-resumo").html(resumoCenarios[FINAL].custosEnergeticos+" €"),$("#reducao-consumos-1-resumo").html(resumoCenarios[INICIAL].consumoAnual-resumoCenarios[FINAL].consumoAnual+" kWh"),$("#reducao-consumos-2-resumo").html((100*(1-resumoCenarios[FINAL].consumoAnual/resumoCenarios[INICIAL].consumoAnual)).toFixed(0)+"%"),$("#reducao-custos-1-resumo").html(resumoGeral.reducaoCustos1+" €"),$("#reducao-custos-2-resumo").html(resumoGeral.reducaoCustos2+"%"),$("#investimento-resumo").html(resumoGeral.investimento+" €"),resumoGeral.payback<0?$("#payback-resumo").html(" -"):$("#payback-resumo").html(resumoGeral.payback+" anos")}function nextStep(){var e=$(".step:visible").data("id"),o=$(".step:visible").data("id")+1;$('[data-id="'+e+'"]').hide(),$('[data-id="'+o+'"]').show(),$(".anterior:hidden").length>1&&($(".anterior").show(),$(".custo-iluminacao-box").hide(),$("#tipo-iluminacao").attr("disabled","disabled").addClass("sel-disable")),2==o&&($(".dados-titulo").hide(),$(".but-2").hide(),$(".recolhe-medidas-but").show(),$(".end-step").hide()),3==o&&($(".but-2").hide(),$(".recolhe-medidas-but").hide(),$(".end-step").show()),4==o&&($(".but-2").hide(),$(".recolhe-medidas-but").hide(),$(".end-step").show(),$("#reload-but").show(),$(".print_pdf").show(),$(".resumo-but").hide())}function prevStep(){var e=$(".step:visible").data("id"),o=$(".step:visible").data("id")-1;$('[data-id="'+e+'"]').hide(),$('[data-id="'+o+'"]').show(),1==o&&($(".dados-titulo").show(),$(".but-2").show(),$(".recolhe-medidas-but").hide(),$(".end-step").hide(),$(".anterior").hide(),$(".custo-iluminacao-box").show(),$("#tipo-iluminacao").removeAttr("disabled","disabled").removeClass("sel-disable")),2==o&&($(".but-2").hide(),$(".recolhe-medidas-but").show(),$(".end-step").hide()),3==o&&($(".but-2").hide(),$(".recolhe-medidas-but").hide(),$(".end-step").show(),$("#reload-but").hide(),$(".resumo-but").show())}$(document).ready(function(){buildTipoIluminacao(),checkTipoIluminacao(),buildEspaco(),$("#fonte-luz-but").on("click",function(){recolheDados()}),$("#medidas-but").on("click",function(){recolheFonteLuz()}),$("#resumo-but").on("click",function(){recolheMedidas()}),$("#reload-but").click(function(){location.reload()}),$("#tipo-iluminacao").change(function(){0==$("#tipo-iluminacao").val()&&""!=$("#tipo-iluminacao").val()?($("#exterior-ilu").hide(),$("#interior-ilu").show()):1==$("#tipo-iluminacao").val()&&""!=$("#tipo-iluminacao").val()&&($("#exterior-ilu").show(),$("#interior-ilu").hide())})});