function buildTipoIluminacao(){for(var e=0;e<tipoInstalacao.length;e++)$("#tipo-iluminacao").append($('<option class="op"> </option>').val(e).html(tipoInstalacao[e].nome))}function buildDadosTable(){if(espacoCount=0,espacoCount++,tipoInstalacao[$("#tipo-iluminacao").val()].nome==EXTERIOR){estado=EXTERIOR;var e='<table class="table table-bordered" id="dataTable"><tbody><tr style="font-weight:bold;" class="titulo_row"><th class="tituloTH">Espaço</th><th class="tituloTH">Designação</th><th class="tituloTH">&nbsp</th></tr>';e+='<tr class="textTR" name="espaco" id="clone1" hidden>',e+='<td class="in"></td>',e+='<td class="in"><input class="form-control xInput" type="text" placeholder="Designação" id="designacao" name="designacao"></input></td>',e+='<td class="in"><button class="but-dados" type="button" id="remove-espaco" name="remove-espaco" onclick="removeEspaco(this)">Remover</button></td>',e+="</tr>",e+='<tr class="textTR" name="espaco">',e+='<td class="in">'+espacoCount+"</td>",e+='<td class="in"><input class="form-control xInput" type="text" placeholder="Designação" id="designacao'+espacoCount+'" name="designacao"></input></td>',e+='<td class="in"><button class="but-dados" type="button" id="remove-espaco" name="remove-espaco" onclick="removeEspaco(this)">Remover</button></td>',e+="</tr>",e+='<tr class="textTR" name="espaco" id="adiciona-row"><td class="in"></td><td class="in"></td><td class="in"><button class="but-dados" type="button" id="adiciona-espaco" name="adiciona-espaco" onclick="adicionaEspaco()">Adicionar</button></td></tr>'}else if(tipoInstalacao[$("#tipo-iluminacao").val()].nome==INTERIOR){estado=INTERIOR;var e='<table class="table table-bordered" id="dataTable"><tbody><tr style="font-weight:bold;" class="titulo_row"><th class="tituloTH">Espaço</th><th class="tituloTH">Tipologia do espaço</th><th class="tituloTH">Designação</th><th class="tituloTH">Área (m2)</th><th class="tituloTH">&nbsp</th></tr>';e+='<tr class="textTR" name="espaco" id="clone1" hidden>',e+='<td class="in"></td>',e+='<td class="select-cell"><select name="tipologia" class="interior" id="tipologia">',e+='<option class="op">Seleccionar opção</option>';for(var t=0;t<tipoTipologia.length;t++)e+='<option class="op" value="'+t+'">'+tipoTipologia[t].nome+"</option>";e+="</select></td>",e+='<td class="in"><input class="form-control xInput" type="text" placeholder="Designação" id="designacao" name="designacao"></input></td>',e+='<td class="in"><input class="form-control xInput" type="number" placeholder="Área" class="interior" id="area" name="area"></input></td>',e+='<td class="in"><button class="but-dados" type="button" id="remove-espaco" name="remove-espaco" onclick="removeEspaco(this)">Remover</button></td>',e+="</tr>",e+='<tr class="textTR" name="espaco">',e+='<td class="in">'+espacoCount+"</td>",e+='<td class="select-cell"><select name="tipologia" class="interior" id="tipologia'+espacoCount+'">',e+='<option class="op">Seleccionar opção</option>';for(var t=0;t<tipoTipologia.length;t++)e+='<option class="op" value="'+t+'">'+tipoTipologia[t].nome+"</option>";e+="</select></td>",e+='<td class="in"><input class="form-control xInput" type="text" placeholder="Designação" id="designacao'+espacoCount+'" name="designacao"></input></td>',e+='<td class="in"><input class="form-control xInput" type="number" placeholder="Área" class="interior" id="area'+espacoCount+'" name="area"></input></td>',e+='<td class="in"><button class="but-dados" type="button" id="remove-espaco" name="remove-espaco" onclick="removeEspaco(this)">Remover</button></td>',e+="</tr>",e+='<tr class="textTR" name="espaco" id="adiciona-row"><td class="in"></td><td class="in"></td><td class="in"></td><td class="in"></td><td class="in"><button class="but-dados" type="button" id="adiciona-espaco" name="adiciona-espaco" onclick="adicionaEspaco()">Adicionar</button></td></tr>',e+="<tr>",e+='<td colspan="3">TOTAL</td>',e+='<td id="total-area">0m2</td>',e+="<td>&nbsp</td>",e+="</tr>"}$("#espacos-iluminacao").html(e+"</tbody></table>");var o=document.getElementsByName("area");$(o).change(function(e){var t=totalArea(o);$("#total-area").html(t+" m2")})}function buildEspaco(){for(var e=0;e<tipoTipologia.length;e++)$("#tipologia").append($('<option class="op"> </option>').val(e).html(tipoTipologia[e].nome));adicionaEspaco()}function buildFonteLuz(){var e=document.getElementsByName("espaco-fonte-luz");for(o=e.length-1;o>0;o--)$(e[o]).remove();var t=document.getElementsByName("tipo-fonte-luz-op");for(o=t.length-1;o>=0;o--)$(t[o]).remove();for(var o=0;o<tipoFonteLuz.length;o++)for(var a=0;a<tipoFonteLuz[o].aplicacaoPotencia.length;a++)if(tipoFonteLuz[o].aplicacaoPotencia[a].match(estado)){$("#tipo-fonte-luz").append($('<option name="tipo-fonte-luz-op" class="op"></option>').val(o).html(tipoFonteLuz[o].tipo));break}for(var n=$("#espaco-fonte-luz"),i,o=1;o<=espacoCount;o++){espaco[o].id=o,i=n.clone(),i.find("td").eq(0).html(o),i.find("td").eq(1).html(espaco[o].designacao),i.find("td").eq(2).find("input").attr("id","quantidade-fonte-luz"+o),i.find("td").eq(3).find("select").attr("id","tipo-fonte-luz"+o),i.find("td").eq(4).find("select").attr("id","potencia-fonte-luz"+o),i.find("td").eq(5).find("input").attr("id","potencia-fonte-luz-input"+o),i.find("td").eq(6).find("input").attr("id","horas-funcionamento-fonte-luz"+o),i.insertBefore("#total-fonte-luz-row"),i.show();var s=document.getElementsByName("quantidade-fonte-luz"),d=document.getElementsByName("potencia-fonte-luz"),c=i.find("td").eq(2).find("input"),l=i.find("td").eq(4).find("select");$(c).change(function(e){var t=totalQtFonteLuz(s);$("#total-fonte-luz-row").find("td").eq(1).html(t),t=totalPotenciaFonteLuz(d),$("#total-fonte-luz-row").find("td").eq(2).html(t+"W")}),$(l).change(function(e){var t=totalPotenciaFonteLuz(d);$("#total-fonte-luz-row").find("td").eq(2).html(t+"W")});var r=document.getElementsByName("tipo-fonte-luz"),u=i.find("td").eq(3).find("select");$(u).change(function(e){var t=$(e.target).parent("td").parent("tr").find("td").eq(5),o=$(e.target).parent("td").parent("tr").find("td").eq(7).find("input"),a=$(e.target).parent("td").parent("tr").find("td").eq(4);$(e.target).val()==OUTROS?($(t).change(function(){var e=totalPotenciaFonteLuz(d);$("#total-fonte-luz-row").find("td").eq(2).html(e+"W")}),a.hide(),t.show(),o.val(""),o.removeAttr("disabled")):(o.val(tipoFonteLuz[$(e.target).val()].rendimento),a.show(),t.hide())})}checkFonteLuz()}function buildMedidas(){$("#reguladores-fluxo-medidas").find("option:gt(0)").remove(),$("#sensores-medidas").find("option:gt(0)").remove(),$("#sistemas-gestao-medidas").find("option:gt(0)").remove(),$("#fonte-luz-medidas").find("option:gt(0)").remove();var e=document.getElementsByName("espaco-medidas");for(t=e.length-1;t>0;t--)$(e[t]).remove();for(var t=0;t<tipoMedidas.length;t++)$("#reguladores-fluxo-medidas").append($('<option class="op"> </option>').val(t).html(tipoMedidas[t])),$("#sensores-medidas").append($('<option class="op"> </option>').val(t).html(tipoMedidas[t])),$("#sistemas-gestao-medidas").append($('<option class="op"> </option>').val(t).html(tipoMedidas[t]));for(t=0;t<medidas.length;t++)if(medidas[t].tipo===FONTE_LUZ){var o=!1;for(j=0;j<fonteLuz.length;j++)if(fonteLuz[j].potenciaUnitFinal==medidas[t].nome){o=!0;break}o||$("#fonte-luz-medidas").append($('<option class="op"> </option>').val(t).html(medidas[t].nome))}for(var a=$("#espaco-medidas"),n,t=1;t<=espacoCount;t++)n=a.clone(),n.find("td").eq(0).html(t),n.find("td").eq(1).html(espaco[t].designacao),n.find("td").eq(2).find("select").attr("id","fonte-luz-medidas"+t),n.find("td").eq(3).find("select").attr("id","reguladores-fluxo-medidas"+t),n.find("td").eq(4).find("select").attr("id","sensores-medidas"+t),n.find("td").eq(5).find("select").attr("id","sistemas-gestao-medidas"+t),n.insertBefore("#total-medidas-row"),n.show()}function calculaHorasFuncionamento(){var e=document.getElementsByName("quantidade-fonte-luz");$(e).change(function(e){var t=$(e.target),o=t.parent("td").parent("tr").find("td").eq(6).find("input");estado==EXTERIOR&&t.val()>0?o.val(horasAnuaisFunc):o.val(0)})}function geraPotencia(){var e=document.getElementsByName("tipo-fonte-luz"),t="",o="";$(e).change(function(e){if(t=$(e.target).parent("td").parent("tr").find("td").eq(4).find("select"),""!=$(e.target).val()){o=$(e.target).val(),$(t).length>0&&($(t).find("option").remove(),$(t).append($('<option value="">Seleccionar opção</option>')));for(var a=0;a<tipoFonteLuz[o].aplicacaoPotencia.length;a++)tipoFonteLuz[o].aplicacaoPotencia[a].match(estado)&&$(t).append($('<option class="op"> </option>').val(a).html(tipoFonteLuz[o].potencia[a]))}else $(t).find("option").remove(),$(t).append($('<option value="">Seleccionar opção</option>'))})}function checkFonteLuz(){geraPotencia(),calculaHorasFuncionamento()}function checkTipoIluminacao(){$("#tipo-iluminacao").change(function(){""!=$("#tipo-iluminacao").val()?($("#custo-unit-iluminacao-titulo").show(),$("#custo-unit-iluminacao").show(),$("#custo-unit-iluminacao").val(tipoInstalacao[$("#tipo-iluminacao").val()].custo_unit),$("#iluminacao").show(),tipoInstalacao[$("#tipo-iluminacao").val()].nome==INTERIOR?(estado=INTERIOR,estadoNum=INT,showInterior()):tipoInstalacao[$("#tipo-iluminacao").val()].nome==EXTERIOR&&(estado=EXTERIOR,estadoNum=EXT,showExterior()),buildDadosTable()):($("#iluminacao").hide(),$("#custo-unit-iluminacao").hide())})}function showExterior(){$(".interior").hide(),$(".col-medida").removeAttr('colspan="4"').attr('colspan="3"')}function showInterior(){$(".interior").show()}function removeEspaco(e){$(e).closest("tr").remove(),espacoCount--;var t=document.getElementsByName("area"),o=totalArea(t);$("#total-area").html(o+" m2")}function adicionaEspaco(){espacoCount++;var e=$("#clone1"),t=e.clone();t.find("td").eq(0).html(espacoCount),t.find("td").eq(1).find("select").attr("id","tipologia"+espacoCount),t.find("td").eq(2).find("input").attr("id","designacao"+espacoCount),t.find("td").eq(3).find("input").attr("id","area"+espacoCount),t.find("td").eq(4).find("button").attr("id","remove-espaco"+espacoCount),t.insertBefore("#adiciona-row"),t.show();var o=document.getElementsByName("area");$(o).change(function(e){var t=totalArea(o);$("#total-area").html(t+" m2")})}function recolheDados(){for(var e=document.getElementsByName("espaco");espaco.length>1;)espaco.pop();for(var t=1;t<=espacoCount;t++)if(estado==INTERIOR){var o=$(e[t]).find("td").eq(1).find("select").val(),a=$(e[t]).find("td").eq(2).find("input").val(),n=$(e[t]).find("td").eq(3).find("input").val();espaco.push({id:t,tipologia:o,designacao:a,area:n})}else if(estado==EXTERIOR){var a=$(e[t]).find("td").eq(1).find("input").val();espaco.push({id:t,designacao:a})}tipoInstalacao[estadoNum].custo_unit=$("#custo-unit-iluminacao").val(),checkCamposDados()}function checkCamposDados(){var e=!1;if(espaco.length>1)for(var t=1;t<espaco.length;t++){if(estado==INTERIOR){if(""!==espaco[t].area&&espaco[t].area>0&&""!==espaco[t].designacao&&""!==espaco[t].tipologia&&tipoInstalacao[estadoNum].custo_unit>0)continue;alert("Faltam preencher campos"),e=!0;break}if(estado==EXTERIOR){if(""!==espaco[t].designacao&&tipoInstalacao[estadoNum].custo_unit>0)continue;alert("Faltam preencher campos"),e=!0;break}}else alert("É necessário pelo menos 1 espaço para continuar");e||(nextStep(),buildFonteLuz())}function recolheFonteLuz(){for(var e=document.getElementsByName("espaco-fonte-luz");fonteLuz.length>1;)fonteLuz.pop();for(var t=1;t<=espacoCount;t++){var o=$(e[t]).find("td").eq(1).text(),a=$(e[t]).find("td").eq(2).find("input").val(),n=$(e[t]).find("td").eq(7).find("input").val(),i=$(e[t]).find("td").eq(3).find("select").val();if(i==OUTROS)var s=$(e[t]).find("td").eq(5).find("input").val();else var s=$(e[t]).find("td").eq(4).find("select").val();var d=calculaAP_BP(s,tipoFonteLuz[i].rendimento,tipoFonteLuz[LED].rendimento);d>=25?estadoPotenciaUnitFinal=BP:d<25&&(estadoPotenciaUnitFinal=AP);var c=$(e[t]).find("td").eq(6).find("input").val();fonteLuz.push({espacoNum:t,designacao:o,quantidade:a,tipo:i,potencia:s,horasFuncionamento:c,potenciaUnitFinal:estadoPotenciaUnitFinal,rendimento:n})}checkCamposFonteLuz()}function checkCamposFonteLuz(){for(var e=!1,t=1;t<fonteLuz.length;t++)if(!(fonteLuz[t].quantidade>=0&&""!==fonteLuz[t].tipo&&""!==fonteLuz[t].potencia&&fonteLuz[t].horasFuncionamento>0)){alert("Faltam preencher campos"),e=!0;break}e||(nextStep(),firstTimeMedidas=!1,buildMedidas(),calculaCenarioInicial())}function recolheMedidas(){for(var e=document.getElementsByName("espaco-medidas");medidasDados.length>1;)medidasDados.pop();for(var t=1;t<=espacoCount;t++){var o=$(e[t]).find("td").eq(1).text(),a=$(e[t]).find("td").eq(2).find("select").val(),n=$(e[t]).find("td").eq(3).find("select").val(),i=$(e[t]).find("td").eq(4).find("select").val(),s=$(e[t]).find("td").eq(5).find("select").val();medidasDados.push({espacoNum:t,designacao:o,fonteLuz:a,reguladoresFluxo:n,sensores:i,sistemaGestao:s})}checkCamposMedidas()}function checkCamposMedidas(){for(var e=!1,t=1;t<medidasDados.length;t++){if(estado==EXTERIOR){if(""!==medidasDados[t].fonteLuz&&""!==medidasDados[t].reguladoresFluxo&&""!==medidasDados[t].sistemaGestao)continue;alert("Faltam preencher campos"),e=!0;break}if(estado==INTERIOR){if(""!==medidasDados[t].fonteLuz&&""!==medidasDados[t].reguladoresFluxo&&""!==medidasDados[t].sensores&&""!==medidasDados[t].sistemaGestao)continue;alert("Faltam preencher campos"),e=!0;break}}e||(nextStep(),calculaCenarioFinal(),calculaInvestimento(),buildResumo())}function buildResumo(){resumoCenarios[0].potencia=cenarioInicial[TOTAL].potencia.toFixed(0),resumoCenarios[0].consumoAnual=cenarioInicial[TOTAL].consumo.toFixed(0),resumoCenarios[0].custosEnergeticos=cenarioInicial[TOTAL].custoEnergia.toFixed(0),resumoCenarios[1].potencia=cenarioFinal[TOTAL].potencia.toFixed(0),resumoCenarios[1].consumoAnual=cenarioFinal[TOTAL].consumoFinal.toFixed(0),resumoCenarios[1].custosEnergeticos=cenarioFinal[TOTAL].custoEnergia.toFixed(0),resumoGeral.reducaoCustos1=investimento[TOTAL].reducaoCustos1.toFixed(0),resumoGeral.reducaoCustos2=100*cenarioFinal[TOTAL].reducaoAnual.toFixed(0),resumoGeral.investimento=investimento[TOTAL].investimento.toFixed(0),resumoGeral.payback=investimento[TOTAL].pri.toFixed(1),$("#potencia-1-resumo").html(resumoCenarios[INICIAL].potencia+" W"),$("#consumo-anual-1-resumo").html(resumoCenarios[INICIAL].consumoAnual+" kWh"),$("#custos-energeticos-1-resumo").html(resumoCenarios[INICIAL].custosEnergeticos+" €"),$("#potencia-2-resumo").html(resumoCenarios[FINAL].potencia+" W"),$("#consumo-anual-2-resumo").html(resumoCenarios[FINAL].consumoAnual+" kWh"),$("#custos-energeticos-2-resumo").html(resumoCenarios[FINAL].custosEnergeticos+" €"),$("#reducao-custos-1-resumo").html(resumoGeral.reducaoCustos1+" €"),$("#reducao-custos-2-resumo").html(resumoGeral.reducaoCustos2+"%"),$("#investimento-resumo").html(resumoGeral.investimento+" €"),$("#payback-resumo").html(resumoGeral.payback+" anos")}function nextStep(){var e=$(".step:visible").data("id"),t=$(".step:visible").data("id")+1;$('[data-id="'+e+'"]').hide(),$('[data-id="'+t+'"]').show(),$(".anterior:hidden").length>1&&$(".anterior").show(),2==t&&($(".but-2").hide(),$(".recolhe-medidas-but").show(),$(".end-step").hide()),3==t&&($(".but-2").hide(),$(".recolhe-medidas-but").hide(),$(".end-step").show()),4==t&&($(".but-2").hide(),$(".recolhe-medidas-but").hide(),$(".end-step").show(),$(".resumo-but").hide())}function prevStep(){var e=$(".step:visible").data("id"),t=$(".step:visible").data("id")-1;$('[data-id="'+e+'"]').hide(),$('[data-id="'+t+'"]').show(),1==t&&($(".but-2").show(),$(".recolhe-medidas-but").hide(),$(".end-step").hide(),$(".anterior").hide()),2==t&&($(".but-2").hide(),$(".recolhe-medidas-but").show(),$(".end-step").hide()),3==t&&($(".but-2").hide(),$(".recolhe-medidas-but").hide(),$(".end-step").show(),$(".resumo-but").show())}$(document).ready(function(){buildTipoIluminacao(),checkTipoIluminacao(),buildEspaco(),$("#fonte-luz-but").on("click",function(){recolheDados()}),$("#medidas-but").on("click",function(){recolheFonteLuz()}),$("#resumo-but").on("click",function(){recolheMedidas()})});